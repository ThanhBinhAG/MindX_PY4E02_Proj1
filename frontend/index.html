<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéÆ Steam Game Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #111827;
      --bg-medium: #1f2937;
      --bg-light: #374151;
      --text-primary: #f3f4f6;
      --text-secondary: #9ca3af;
      --accent-blue: #60a5fa;
      --accent-green: #34d399;
    } 
    
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: var(--bg-dark);
      color: var(--text-primary);
      font-weight: 300;
      -webkit-font-smoothing: antialiased;
    }

    header {
      padding: 16px 30px;
      background: var(--bg-medium);
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      border-bottom: 1px solid var(--bg-light);
    }
    
    header h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.5px;
      color: var(--accent-blue);
      font-weight: 500;
    }

    main {
      padding: 24px;
      max-width: 1200px;
      margin: 20px auto;
      animation: fadeIn 0.7s ease-in-out;
    }

    /* === B·ªò L·ªåC === */
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 24px;
      align-items: center;
      background: var(--bg-medium);
      padding: 16px;
      border-radius: 10px;
    }
    
    .filters label {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-right: -4px;
    }

    .input-wrap { position: relative; display: inline-block; }
    .suggest-dropdown {
      position: absolute; top: calc(100% + 6px); left: 0; right: 0;
      background: var(--bg-medium);
      border: 1px solid var(--bg-light);
      border-radius: 8px; padding: 6px 0; z-index: 20;
      box-shadow: 0 8px 18px rgba(0,0,0,0.35);
      max-height: 280px; overflow: auto;
      display: none;
    }
    .suggest-item { padding: 8px 12px; cursor: pointer; display: flex; justify-content: space-between; gap: 10px; }
    .suggest-item:hover { background: rgba(96,165,250,0.08); }
    .suggest-name { color: var(--text-primary); }
    .suggest-meta { color: var(--text-secondary); font-size: 12px; white-space: nowrap; }

    select {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--bg-light);
      background: var(--bg-dark);
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'Poppins', sans-serif;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    select:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.3);
    }

    /* === TH·∫∫ TR·ªä S·ªê (KPI) === */
    .kpi-grid {
      display: grid;
      /* T·ª± ƒë·ªông chia c·ªôt, m·ªói c·ªôt t·ªëi thi·ªÉu 200px, t·ªëi ƒëa 1fr */
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .card {
      display: flex;
      align-items: center;
      gap: 16px;
      background: var(--bg-medium);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .card:hover { 
      transform: translateY(-4px); 
      box-shadow: 0 6px 15px rgba(0,0,0,0.4);
    }
    
    .card-icon {
      font-size: 2.5rem;
      line-height: 1;
    }
    
    .card-content {
      display: flex;
      flex-direction: column;
    }
    
    .card-title {
      font-size: 14px;
      color: var(--text-secondary);
      font-weight: 400;
    }
    
    .card-value {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    /* === KHUNG CH·ª®A BI·ªÇU ƒê·ªí === */
    .chart-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr); /* L∆∞·ªõi 3 c·ªôt */
      gap: 20px;
    }
    
    .chart-container {
      background: var(--bg-medium);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      /* ƒê·∫∑t chi·ªÅu cao cho th·∫ª ch·ª©a */
      position: relative;
    }
    
    /* G√°n chi·ªÅu cao kh√°c nhau cho c√°c lo·∫°i bi·ªÉu ƒë·ªì */
    .chart-container.chart-bar {
      grid-column: span 3; /* Bi·ªÉu ƒë·ªì Bar chi·∫øm 3 c·ªôt */
      height: 350px;
    }
    .chart-container.chart-line {
      grid-column: span 2; /* Bi·ªÉu ƒë·ªì Line chi·∫øm 2 c·ªôt */
      height: 300px;
    }
    .chart-container.chart-pie {
      grid-column: span 1; /* Bi·ªÉu ƒë·ªì Pie chi·∫øm 1 c·ªôt */
      height: 300px;
    }
    
    .chart-container h3 {
      margin-top: 0;
      margin-bottom: 16px;
      font-size: 18px;
      font-weight: 500;
      color: var(--text-primary);
    }

    /* Canvas s·∫Ω l·∫•p ƒë·∫ßy th·∫ª ch·ª©a n√≥ */
    canvas {
      width: 100%;
      height: 100%;
    }

    /* === RESPONSIVE === */
    @media (max-width: 900px) {
      .chart-container.chart-line {
        grid-column: span 3; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
      }
      .chart-container.chart-pie {
        grid-column: span 3; /* Chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
      }
    }
    
    @media (max-width: 768px) {
      main { padding: 16px; }
      .kpi-grid {
        grid-template-columns: 1fr; /* 1 c·ªôt tr√™n di ƒë·ªông */
      }
      .chart-grid {
        grid-template-columns: 1fr; /* 1 c·ªôt tr√™n di ƒë·ªông */
      }
      /* Reset grid span tr√™n di ƒë·ªông */
      .chart-container.chart-bar,
      .chart-container.chart-line,
      .chart-container.chart-pie {
        grid-column: span 1;
      }
    }

    @keyframes fadeIn { 
      from { opacity: 0; transform: translateY(10px); } 
      to { opacity: 1; transform: none; } 
    }

    /* === BUTTONS === */
    .btn {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--bg-light);
      background: var(--bg-dark);
      color: var(--text-primary);
      cursor: pointer;
      transition: box-shadow .2s, transform .05s, border-color .2s, color .2s;
    }
    .btn:hover { box-shadow: 0 0 0 3px rgba(96,165,250,.2); border-color: var(--accent-blue); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: var(--accent-green); color: var(--accent-green); }
    .btn.secondary { border-color: var(--accent-blue); color: var(--accent-blue); }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn.loading { position: relative; color: transparent; }
    .btn.loading::after {
      content: '';
      position: absolute; inset: 0; margin: auto; width: 14px; height: 14px;
      border: 2px solid var(--accent-blue); border-top-color: transparent; border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <header><h1>üéÆ Steam Game Analytics Dashboard</h1></header>
  
  <main>
    <div class="filters">
      <label for="genreSelect">Th·ªÉ lo·∫°i:</label>
      <select id="genreSelect">
        <option value="">T·∫•t c·∫£</option>
      </select>
      <label for="yearSelect">NƒÉm:</label>
      <select id="yearSelect">
        <option value="">T·∫•t c·∫£</option>
      </select>
      <label for="qInput">T√¨m ki·∫øm:</label>
      <span class="input-wrap">
        <input id="qInput" type="text" placeholder="T√™n game..." style="padding:8px 12px;border-radius:6px;border:1px solid var(--bg-light);background:var(--bg-dark);color:var(--text-primary);min-width:240px;"/>
        <div id="suggest" class="suggest-dropdown"></div>
      </span>
      <label for="minPrice">Gi√° t·ªëi thi·ªÉu:</label>
      <select id="minPrice">
        <option value="">B·∫•t k·ª≥</option>
        <option value="0">0</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="60">60</option>
      </select>
      <label for="maxPrice">Gi√° t·ªëi ƒëa:</label>
      <select id="maxPrice">
        <option value="">B·∫•t k·ª≥</option>
        <option value="5">5</option>
        <option value="10">10</option>
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="60">60</option>
        <option value="100">100</option>
      </select>
      <div style="margin-left:auto; display:flex; gap:8px;">
        <button id="applyBtn" class="btn primary">√Åp d·ª•ng</button>
        <button id="resetBtn" class="btn secondary">Reset</button>
      </div>
    </div>

    <div class="kpi-grid">
      <div class="card">
        <div class="card-icon">üéÆ</div>
        <div class="card-content">
          <span class="card-title">T·ªïng s·ªë Game</span>
          <span class="card-value" id="total-value">‚Äî</span>
        </div>
      </div>
      <div class="card">
        <div class="card-icon">üí≤</div>
        <div class="card-content">
          <span class="card-title">Gi√° trung b√¨nh</span>
          <span class="card-value" id="price-value">‚Äî</span>
        </div>
      </div>
      <div class="card">
        <div class="card-icon">üèÜ</div>
        <div class="card-content">
          <span class="card-title">Th·ªÉ lo·∫°i Top</span>
          <span class="card-value" id="genre-value">‚Äî</span>
        </div>
      </div>
      <div class="card">
        <div class="card-icon">üë•</div>
        <div class="card-content">
          <span class="card-title">T·ªïng s·ªü h·ªØu</span>
          <span class="card-value" id="owners-value">‚Äî</span>
        </div>
      </div>
    </div>

    <div class="chart-grid">
      
      <div class="chart-container chart-bar">
        <h3>Top 10 Game ph·ªï bi·∫øn</h3>
        <canvas id="topChart"></canvas>
      </div>
      
      <div class="chart-container chart-line">
        <h3>S·ªë l∆∞·ª£ng Game theo nƒÉm</h3>
        <canvas id="seriesChart"></canvas>
      </div>

      <div class="chart-container chart-pie">
        <h3>T·ª∑ l·ªá Th·ªÉ lo·∫°i (Top 8)</h3>
        <canvas id="pieChart"></canvas>
      </div>

      <div class="chart-container chart-line">
        <h3>ƒê√°nh gi√° vs L∆∞·ª£t ƒë√°nh gi√°</h3>
        <canvas id="reviewChart"></canvas>
      </div>
      
    </div>
  </main>

<script>
// === C√ÄI ƒê·∫∂T CHART.JS M·∫∂C ƒê·ªäNH ===
Chart.defaults.color = '#9ca3af'; // M√†u ch·ªØ m·∫∑c ƒë·ªãnh (tr·ª•c, nh√£n)
Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)'; // M√†u l∆∞·ªõi
Chart.defaults.plugins.legend.labels.color = '#f3f4f6'; // M√†u ch·ªØ c·ªßa legend
Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0, 0, 0, 0.8)';
Chart.defaults.plugins.tooltip.titleColor = '#f3f4f6';
Chart.defaults.plugins.tooltip.bodyColor = '#f3f4f6';

const base = location.origin;
const genreSelect = document.getElementById('genreSelect');
const yearSelect = document.getElementById('yearSelect');
const qInput = document.getElementById('qInput');
const minPrice = document.getElementById('minPrice');
const maxPrice = document.getElementById('maxPrice');
const resetBtn = document.getElementById('resetBtn');
const applyBtn = document.getElementById('applyBtn');
const suggest = document.getElementById('suggest');

async function fetchJSON(url){ const r = await fetch(url); return r.json(); }

async function loadFilters(){
  const genres = await fetchJSON(base + '/api/aggregate?by=genre');
  const years = await fetchJSON(base + '/api/series?metric=count');
  
  // L·∫•y 30 th·ªÉ lo·∫°i ƒë·∫ßu
  Object.keys(genres).slice(0,30).forEach(g=>{
    const opt=document.createElement('option');
    opt.value=g; opt.textContent=g;
    genreSelect.appendChild(opt);
  });
  
  // S·∫Øp x·∫øp nƒÉm
  Object.keys(years).sort().forEach(y=>{
    const opt=document.createElement('option');
    opt.value=y; opt.textContent=y;
    yearSelect.appendChild(opt);
  });
}

function setLoading(isLoading){
  if (!applyBtn || !resetBtn) return;
  applyBtn.disabled = isLoading;
  resetBtn.disabled = isLoading;
  applyBtn.classList.toggle('loading', isLoading);
}

async function updateDashboard(){
  setLoading(true);
  const genre = genreSelect.value;
  const year = yearSelect.value;
  const q = qInput.value.trim();
  const minP = minPrice.value;
  const maxP = maxPrice.value;
  let params = '';
  if(genre) params += `&genre=${encodeURIComponent(genre)}`;
  if(year) params += `&start=${year}-01-01&end=${year}-12-31`;
  if(q) params += `&q=${encodeURIComponent(q)}`;
  if(minP) params += `&min_price=${encodeURIComponent(minP)}`;
  if(maxP) params += `&max_price=${encodeURIComponent(maxP)}`;

  let summary, top, series, agg, reviews;
  try {
    [summary, top, series, agg, reviews] = await Promise.all([
      fetchJSON(base + '/api/stats/summary?' + params),
      fetchJSON(base + '/api/top?metric=popularity&n=10' + params),
      fetchJSON(base + '/api/series?metric=count' + params),
      fetchJSON(base + '/api/aggregate?by=genre' + params),
      fetchJSON(base + '/api/reviews?n=50' + params)
    ]);
  } finally {
    setLoading(false);
  }

  // C·∫≠p nh·∫≠t c√°c th·∫ª KPI
  document.getElementById('total-value').innerText = summary.total_games;
  document.getElementById('price-value').innerText = `$${summary.avg_price}`;
  document.getElementById('genre-value').innerText = summary.top_genre;
  document.getElementById('owners-value').innerText = summary.total_owners.toLocaleString();

  renderCharts(top, series, agg, reviews);
}

let charts = [];
function renderCharts(top, series, agg, reviews){
  // X√≥a c√°c bi·ªÉu ƒë·ªì c≈© tr∆∞·ªõc khi v·∫Ω m·ªõi
  charts.forEach(c=>c.destroy());
  charts = [];

  const ctxTop = document.getElementById('topChart').getContext('2d');
  const ctxSeries = document.getElementById('seriesChart').getContext('2d');
  const ctxPie = document.getElementById('pieChart').getContext('2d');
  const ctxReview = document.getElementById('reviewChart').getContext('2d');

  // M√†u Gradient cho bi·ªÉu ƒë·ªì Bar
  const gradient = ctxTop.createLinearGradient(0, 0, 0, ctxTop.canvas.clientHeight);
  gradient.addColorStop(0, 'rgba(96, 165, 250, 0.8)'); // --accent-blue
  gradient.addColorStop(1, 'rgba(96, 165, 250, 0.2)');

  // 1. Bi·ªÉu ƒë·ªì Top 10 (Bar)
  charts.push(new Chart(ctxTop, {
    type: 'bar',
    data: {
      labels: top.map(x => x.name.length > 20 ? x.name.substring(0, 20) + '...' : x.name), // C·∫Øt b·ªõt t√™n d√†i
      datasets: [{
        label: 'Popularity', 
        data: top.map(x => x.popularity), 
        backgroundColor: gradient,
        borderColor: '#60a5fa',
        borderWidth: 1,
        borderRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            afterBody: (tt) => {
              const i = tt[0].dataIndex;
              const it = top[i];
              if (!it) return '';
              const price = (it.price != null) ? `$${it.price}` : 'N/A';
              return `\nGi√°: ${price}`;
            }
          }
        }
      },
      scales: {
        x: { grid: { display: false } },
        y: { grid: { color: 'rgba(255, 255, 255, 0.1)' } }
      },
      onClick: (evt, elements) => {
        if (!elements || elements.length === 0) return;
        const idx = elements[0].index;
        const item = top[idx];
        if (item && item.appid) {
          const url = item.store_url || (`https://store.steampowered.com/app/${item.appid}/`);
          window.open(url, '_blank');
        }
      }
    }
  }));

  // 2. Bi·ªÉu ƒë·ªì theo nƒÉm (Line)
  const years = Object.keys(series).sort();
  charts.push(new Chart(ctxSeries, {
    type: 'line',
    data: {
      labels: years, 
      datasets: [{
        label: 'S·ªë Game m·ªói nƒÉm', 
        data: years.map(y => series[y]), 
        borderColor: '#34d399', // --accent-green
        backgroundColor: 'rgba(52, 211, 153, 0.1)',
        tension: 0.3, 
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true, position: 'bottom', align: 'start' }
      }
    }
  }));

  // 3. Bi·ªÉu ƒë·ªì th·ªÉ lo·∫°i (Pie)
  const keys = Object.keys(agg).sort((a,b) => agg[b] - agg[a]).slice(0, 8); // S·∫Øp x·∫øp v√† l·∫•y 8 top
  charts.push(new Chart(ctxPie, {
    type: 'doughnut', // 'pie' ho·∫∑c 'doughnut'
    data: {
      labels: keys, 
      datasets: [{
        data: keys.map(k => agg[k]), 
        backgroundColor: [
          '#f87171', '#facc15', '#34d399', '#60a5fa', 
          '#a78bfa', '#f472b6', '#fb923c', '#4ade80'
        ],
        borderWidth: 0
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { 
          position: 'right', // Hi·ªÉn th·ªã legend b√™n ph·∫£i
          labels: {
            boxWidth: 12
          }
        }
      }
    }
  }));

  // 4. Scatter: Positive Rate vs Total Reviews
  const pts = reviews.points || [];
  charts.push(new Chart(ctxReview, {
    type: 'scatter',
    data: {
      datasets: [{
        label: 'Game (Top theo l∆∞·ª£t ƒë√°nh gi√°)',
        data: pts.map(p => ({ x: p.positive_rate_pct, y: p.total_reviews, appid: p.appid, name: p.name, price: p.price, store_url: p.store_url })),
        pointBackgroundColor: '#f59e0b',
        pointBorderColor: '#fbbf24',
        pointRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          title: { display: true, text: 'T·ªâ l·ªá ƒë√°nh gi√° t√≠ch c·ª±c (%)' },
          min: 0, max: 100
        },
        y: {
          title: { display: true, text: 'T·ªïng l∆∞·ª£t ƒë√°nh gi√°' },
          type: 'logarithmic',
          ticks: { callback: (v) => Number(v).toLocaleString() }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: (ctx) => {
              const d = ctx.raw;
              const rate = (d.x ?? 0).toFixed(1) + '%';
              const revs = (d.y ?? 0).toLocaleString();
              const price = (d.price != null) ? `$${d.price}` : 'N/A';
              return `${d.name} ‚Äî ${rate}, ${revs} reviews, ${price}`;
            }
          }
        }
      },
      onClick: (evt, elements) => {
        if (!elements || elements.length === 0) return;
        const el = elements[0];
        const d = el.element.$context.raw;
        if (d && d.appid) {
          const url = d.store_url || (`https://store.steampowered.com/app/${d.appid}/`);
          window.open(url, '_blank');
        }
      }
    }
  }));
}

// === KH·ªûI CH·∫†Y ===
genreSelect.addEventListener('change', updateDashboard);
yearSelect.addEventListener('change', updateDashboard);
qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') updateDashboard(); });
minPrice.addEventListener('change', updateDashboard);
maxPrice.addEventListener('change', updateDashboard);
applyBtn.addEventListener('click', updateDashboard);
resetBtn.addEventListener('click', ()=>{
  genreSelect.value = '';
  yearSelect.value = '';
  qInput.value = '';
  minPrice.value = '';
  maxPrice.value = '';
  updateDashboard();
});

// ==== Autocomplete g·ª£i √Ω t√™n game ====
let suggestTimer;
async function loadSuggest(){
  const q = qInput.value.trim();
  if(!q){ suggest.style.display='none'; suggest.innerHTML=''; return; }
  const genre = genreSelect.value;
  const year = yearSelect.value;
  let params = `?q=${encodeURIComponent(q)}`;
  if(genre) params += `&genre=${encodeURIComponent(genre)}`;
  if(year) params += `&start=${year}-01-01&end=${year}-12-31`;
  try{
    const items = await fetchJSON(base + '/api/suggest' + params);
    if(!Array.isArray(items) || items.length===0){ suggest.style.display='none'; suggest.innerHTML=''; return; }
    suggest.innerHTML = items.map(it=>
      `<div class="suggest-item" data-appid="${it.appid}" data-name="${it.name.replace(/"/g,'&quot;')}">`+
        `<span class="suggest-name">${it.name}</span>`+
        `<span class="suggest-meta">$${(it.price ?? '‚Äî')}</span>`+
      `</div>`
    ).join('');
    suggest.style.display='block';
  }catch{ /* silent */ }
}

qInput.addEventListener('input', ()=>{
  clearTimeout(suggestTimer);
  suggestTimer = setTimeout(loadSuggest, 220);
});

document.addEventListener('click', (e)=>{
  if(!suggest.contains(e.target) && e.target!==qInput){ suggest.style.display='none'; }
});

suggest.addEventListener('click', (e)=>{
  const item = e.target.closest('.suggest-item');
  if(!item) return;
  const name = item.getAttribute('data-name');
  qInput.value = name || '';
  suggest.style.display='none';
  updateDashboard();
});

// T·∫£i b·ªô l·ªçc, sau ƒë√≥ t·∫£i d·ªØ li·ªáu dashboard
loadFilters().then(updateDashboard);
</script>
</body>
</html>